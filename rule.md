# 项目开发规范 (rule.md)

## 测试执行规范

### Python环境配置
- 在某些环境中，`python` 命令可能不可用，需要使用 `python3` 命令
- 生成的Python测试文件都需要在bash环境中手动编译和测试
- 推荐使用 `python3` 命令以确保兼容性

### 测试文件运行方式
```bash
# 如果出现 "python: command not found" 错误
# 应该使用 python3 替代 python
python3 -m mouse._fps_relative_movement_tests
```

### 测试文件设计原则
1. **无用户交互要求**：测试文件应该完全自动化，无需用户手动输入或交互
2. **全场景覆盖**：测试应该尽可能覆盖更多的使用场景和边界情况
3. **直接运行获得结果**：测试执行后应该能直接输出测试结果，无需额外处理
4. **自包含性**：每个测试文件应该包含所有必要的依赖和配置

### 常见问题解决
- **问题**：`/bin/bash: line 1: python: command not found`
- **解决方案**：使用 `python3` 命令替代 `python` 命令

### 依赖处理规范
- **WSL环境依赖缺失**：当前处于WSL环境下，可能缺失某些依赖，但用户在Windows环境中不缺依赖
- **处理策略**：
  1. 在测试脚本时如果出现缺少依赖的问题，应该忽略这个问题
  2. 可以尝试将依赖下载到WSL环境中：`pip3 install --break-system-packages --user [dependency]`
  3. 如果依赖下载失败或不可用，则忽略该问题，不强制解决
  4. 测试的重点是验证代码逻辑，而不是解决环境依赖问题

### WSL环境Python模块安装流程
```bash
# 当遇到缺失模块时的标准安装命令
export PATH=$PATH:/home/pepsi/.local/bin
pip3 install --break-system-packages --user <模块名>

# 常见模块安装示例
pip3 install --break-system-packages --user numpy pandas requests
pip3 install --break-system-packages --user opencv-python pillow
pip3 install --break-system-packages --user ultralytics torch
pip3 install --break-system-packages --user supervision streamlit
```

### 自动依赖管理
- **检测缺失**: 运行测试/脚本时如果出现`ModuleNotFoundError`
- **自动尝试**: 使用标准WSL安装命令尝试安装
- **失败处理**: 如果安装失败，记录并继续执行（不阻塞测试）
- **优先级**: 代码逻辑验证 > 环境依赖解决

### 测试文件编写建议
- 使用标准的测试框架（如 unittest）
- 包含详细的测试用例描述
- 提供清晰的测试结果输出
- 确保测试的可重复性和稳定性

## 核心日志系统规范

### 日志覆盖要求
为了支持持续算法优化和问题定位，系统必须提供**完整的核心流程日志**，包括：

1. **YOLO检测阶段日志**
   - 检测到的目标数量和置信度
   - 每个目标的原始边界框坐标 (x1, y1, x2, y2)
   - 目标类别 (HEAD=7, BODY=0)
   - 计算得出的中心点坐标和尺寸

2. **坐标转换阶段日志**
   - 应用身体/头部偏移前后的坐标对比
   - 屏幕中心到目标的像素偏移计算
   - 像素偏移到鼠标移动的转换过程
   - 转换公式的详细参数和中间结果

3. **鼠标移动执行日志**
   - 最终的鼠标移动命令参数
   - 硬件驱动执行结果
   - 移动距离限制和缩放处理

### 日志格式规范
- **时间戳**: 所有核心日志必须包含精确时间戳 (YYYY-MM-DD HH:MM:SS)
- **流程标识**: 使用统一的标识符区分不同处理阶段
- **数据完整性**: 关键数值保留小数点后1位精度
- **可追踪性**: 同一次检测的所有日志应该可以关联追踪

### 日志用途
- **算法调优**: 基于日志数据分析和优化转换参数
- **问题定位**: 快速识别过冲、偏移等问题的具体环节
- **性能分析**: 评估各阶段的处理时间和效率
- **回归测试**: 验证算法修改对整体流程的影响

### 实现要求
- 核心流程日志不能影响系统性能
- 日志输出必须在异常情况下也能正常工作
- 支持根据配置调整日志详细程度

## AI驱动优化的日志记录规范

### 日志记录核心原则
**目标导向**: 日志的最终目的是为AI分析和迭代优化提供数据支持

### 关键日志记录要求
1. **问题发现导向**: 记录的日志必须能够帮助发现和定位问题
   - 记录异常值、边界情况、性能瓶颈
   - 包含足够的上下文信息便于问题重现
   - 标注可能的异常或预期外的行为

2. **全流程覆盖**: 整个核心流程的每个关键节点都需要记录日志
   - 输入数据的关键特征和状态
   - 中间处理步骤的转换过程和结果
   - 输出结果和执行效果
   - 性能指标（耗时、成功率、精度等）

3. **AI优化友好**: 日志格式和内容要便于AI分析
   - 使用结构化的数据格式（便于解析）
   - 包含数值型指标便于趋势分析
   - 提供足够的关联信息便于因果分析
   - 记录决策依据和参数选择原因

### 开发者日志策略
**主动思考**: 开发时需要考虑"我后续优化时需要知道哪些信息？"
- 算法参数的选择依据和效果
- 数据转换的中间过程和公式
- 决策分支的条件和结果
- 异常处理的触发条件和处理方式
- 性能优化的关键指标变化

### 日志分析驱动的开发流程
1. **开发阶段**: 预判优化需求，主动添加关键日志
2. **测试阶段**: 收集完整的运行日志数据
3. **分析阶段**: 将日志提供给AI进行深度分析
4. **优化阶段**: 基于AI分析结果调整算法和参数
5. **验证阶段**: 通过日志对比验证优化效果